---
title: "BIOL4408 Marine Ecology: Lobster density 5."
author: "TimLanglois"
date: "15/02/2021"
output: github_document
---

```{r setup, include=FALSE}

library(knitr)
knitr::opts_chunk$set(echo = TRUE)

```


# 5. Format for PRIMER and PERMANOVA+

PRIMER and PERMANOVA+ are very handy pieces of software for multivariate and univariate analyses.
Many multivariate analyses can also be implemented in R using packages such as vegan(), which has a permutational ANOVA function called adonis().
BUT I have found the DistLM and PERMANOVA/PERMANCOVA routines in PRIMER and PERMANOVA+ are more robust than their R equivalents.

In particular for mixed-model designs, PERMANOVA helps you build the correct analytical model if you specify the design correctly. In the R-equivalent vegan::adonis(), mixed model designs are possible but the singificance test and results are potentially wrong/questionable as the numerator and demoninator of the test do not appear to be calculated correctly - as far as I can tell.

Permuation tests and pseduo-F generated by both PERMANOVA and adonis() have been show to be very robust to heterogenity of variance such as that generated by zero rich data. Both can be used with univariate and multivariate data, by choosing the appropriate distance measure.

The draw back of using the PERMANOVA/PERMANCOVA/DistLM routines for univaritate analyses is that you cannot predict from the final model. If you want a predictive model, you need to use some other form of modelling (in R) and use an appropriate error distribution family (e.g. poisson, negative binomial) that fits your data.

The following scripts demonstrate how to format LONG data into WIDE datat for import into PRIMER. Typically people import WIDE data into PRIMER but PRIMER will accept LONG data.


Load extra librarys
```{r libs2, message=FALSE, warning=FALSE}
library(tidyr)
library(plyr) #older R library that has a function we need - can cause conflicts with dplyr() and here()
library(dplyr)
library(readr)
# library(RCurl) #needed to download data from GitHub
# library(here)

```


Set a study name
```{r name, message=FALSE, warning=FALSE}
study<-"lobster.density"
```



```{r , message=FALSE, warning=FALSE}

working.dir<-dirname(rstudioapi::getActiveDocumentContext()$path) # to directory of current file - or type your own

## Save these directory names to use later----
data.dir<-paste(working.dir,"Data",sep="/")
plot.dir<-paste(working.dir,"Plots",sep="/")
primer.dir<-paste(working.dir,"PRIMER",sep="/")

```


Create functions needed for PRIMER format
```{r , message=FALSE, warning=FALSE}
# Needed for PRIMER to append a blank column to distiguish Factors
append_col <- function(x, cols, after=length(x)) {
  x <- as.data.frame(x)
  if (is.character(after)) {
    ind <- which(colnames(x) == after)
    if (any(is.null(ind))) stop(after, "not found in colnames(x)\n")
  } else if (is.numeric(after)) {
    ind <- after
  }
  stopifnot(all(ind <= ncol(x)))
  cbind(x, cols)[, append(1:ncol(x), ncol(x) + 1:length(cols), after=ind)]
}

```


Use here() to make a shortcut to the "Data" directory.

data.dir <- here("Data")

The above code probrably won't work. Do you know why?
By installing the plyr() package above we have created a conflict as plyr() also has a function called here().

We can prevent the conflict by specifying the package from which we want the function to come from.
Using the syntax of package.name::function.name

In other words here::here

```{r here, message=FALSE, warning=FALSE}
data.dir <- here::here("Data")

# or for ecocloud
#data.dir <- here::here("workspace","Template-lobster-density","Data")

```


Create a 'PRIMER' folder if you don't already have one and create a shortcut to it
```{r , message=FALSE, warning=FALSE}
dir.create(file.path(here::here(),"PRIMER")) #create Plots folder

primer.dir=here::here("PRIMER")

# or for ecocloud
# dir.create(file.path(here::here(),"workspace","Template-lobster-density","PRIMER")) #create PRIMER folder
# primer.dir=here::here("workspace","Template-lobster-density","PRIMER")


```


Read in data
```{r read, message=TRUE, warning=FALSE}
setwd(data.dir)#this is out shortcut using here()
dir()

dat<-read_csv("lobster.density.csv")%>%
  glimpse()

```


Makes response variable data
```{r}


response<-dat%>%
  dplyr::select(sample.no,count,size.class)%>%
  pivot_wider(names_from = size.class, values_from = count, values_fill = 0)%>% #to make the data wide for PRIMER
  dplyr::glimpse()
```


Make the covariate data
```{r}
covariates<-dat%>%
  dplyr::select(sample.no,complexity,depth,year)%>%
  dplyr::distinct()%>%
  dplyr::glimpse()

```


Make the factor data
```{r}
factors<-dat%>%
  dplyr::select(c(sample.no,sanctuary,status,site.new,year))%>%
 dplyr::distinct()%>% #only unique combinations - to match the wide data
  glimpse()
```


Join the response.factor data
```{r}
response.factors<-factors%>%
  dplyr::inner_join(response,by="sample.no")%>% #join the data
  dplyr::select(sample.no,legal,sub.legal,all,everything())%>% #orders the colums
  append_col(., list(blank=NA), after="all")%>% #appends blank colum
  plyr::rename(.,replace =c("blank"="") )%>% #makes the column name blank
  glimpse()
```


Join the covariate.factor data
```{r}
covariate.factors<-covariates%>%
  dplyr::inner_join(factors,by="sample.no")%>%
  append_col(., list(blank=NA), after="year.x")%>%
  plyr::rename(.,replace =c("blank"="") )%>%
  glimpse()
```


Write the data
```{r message=FALSE, warning=FALSE}
setwd(primer.dir)
dir()

write.csv(response.factors,file=paste("response.factors",study,"csv",sep = "."), row.names=FALSE)

write.csv(covariate.factors,file=paste("covariate.factors",study,"csv",sep = "."), row.names=FALSE)

dir()
```


Go back to [Analysis-lobster-density](https://github.com/UWA-BIOL4408-Marine-Ecology/Analysis-lobster-density/blob/master/README.md)
