BIOL4408 Marine Ecology: Lobster density 5.
================
TimLanglois
09/01/2020

# 5\. Format for PRIMER and PERMANOVA+

PRIMER and PERMANOVA+ are very handy pieces of software for multivariate
and univariate analyses. Many multivariate analyses can also be
implemented in R using packages such as vegan(), which has a
permutational ANOVA function called adonis(). BUT I have found the
DistLM and PERMANOVA/PERMANCOVA routines in PRIMER and PERMANOVA+ are
more robust than their R equivalents.

In particualr for mixed-model designs, PERMANOVA helps you build the
correct analytical model if you specify the design correctly. In the
R-equivalent vegan::adonis(), mixed model designs are possible but the
singificance test and results are potentially wrong/questionable as the
numerator and demoninator of the test do not appear to be calculated
correctly - as far as I can tell.

Permuation tests and pseduo-F generated by both PERMANOVA and adonis()
have been show to be very robust to heterogenity of variance such as
that generated by zero rich data. Both can be used with univariate and
multivariate data, by choosing the appropriate distance measure.

The draw back of using the PERMANOVA/PERMANCOVA/DistLM routines for
univaritate analyses is that you cannot predict from the final model. If
you want a predictive model, you need to use some other form of
modelling (in R) and use an appropriate error distribution family
(e.g. poisson, negative binomial) that fits your data.

The following scripts demonstrate how to format LONG data into WIDE
datat for import into PRIMER. Typically people import WIDE data into
PRIMER but PRIMER will accept LONG data.

Load extra librarys

``` r
library(tidyr)
library(plyr) #older R library that has a function we need - can cause conflicts with dplyr() and here()
library(dplyr)
library(readr)
library(RCurl) #needed to download data from GitHub
library(here)
```

Set a study name

``` r
study<-"lobster.density"
```

Create functions needed for PRIMER format

``` r
# Needed for PRIMER to append a blank column to distiguish Factors
append_col <- function(x, cols, after=length(x)) {
  x <- as.data.frame(x)
  if (is.character(after)) {
    ind <- which(colnames(x) == after)
    if (any(is.null(ind))) stop(after, "not found in colnames(x)\n")
  } else if (is.numeric(after)) {
    ind <- after
  }
  stopifnot(all(ind <= ncol(x)))
  cbind(x, cols)[, append(1:ncol(x), ncol(x) + 1:length(cols), after=ind)]
}
```

Use here() to make a shortcut to the “Data” directory.

data.dir \<- here(“Data”)

The above code probrably won’t work. Do you know why? By installing the
plyr() package above we have created a conflict as plyr() also has a
function called here().

We can prevent the conflict by specifying the package from which we want
the function to come from. Using the syntax of
package.name::function.name

In other words here::here

``` r
data.dir <- here::here("Data")
```

Create a ‘PRIMER’ folder if you don’t already have one and create a
shortcut to it

``` r
dir.create(file.path(here::here(),"PRIMER")) #create Plots folder

primer.dir=here::here("PRIMER")
```

Read in data

``` r
setwd(data.dir)#this is out shortcut using here()
dir()
```

    ## [1] "lobster.density.csv"        "lobster.density.gsheet.csv"

``` r
dat<-read_csv("lobster.density.csv")%>%
  glimpse()
```

    ## Parsed with column specification:
    ## cols(
    ##   sample.no = col_double(),
    ##   year = col_double(),
    ##   date = col_datetime(format = ""),
    ##   sanctuary = col_character(),
    ##   status = col_character(),
    ##   site.new = col_character(),
    ##   complexity = col_double(),
    ##   algal.cover = col_double(),
    ##   size.class = col_character(),
    ##   count = col_double()
    ## )

    ## Observations: 6,402
    ## Variables: 10
    ## $ sample.no   <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17…
    ## $ year        <dbl> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 201…
    ## $ date        <dttm> 2014-01-26 16:00:00, 2014-01-26 16:00:00, 2014-01-26 16:…
    ## $ sanctuary   <chr> "Armstrong Bay", "Armstrong Bay", "Armstrong Bay", "Armst…
    ## $ status      <chr> "No-take", "No-take", "No-take", "No-take", "No-take", "N…
    ## $ site.new    <chr> "Little Armstrong.No-take", "Little Armstrong.No-take", "…
    ## $ complexity  <dbl> 0, 2, 4, 1, 4, 2, 2, 2, 2, 1, 3, 1, 1, 2, 1, 3, 1, 2, 2, …
    ## $ algal.cover <dbl> 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, …
    ## $ size.class  <chr> "legal", "legal", "legal", "legal", "legal", "legal", "le…
    ## $ count       <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, …

Makes response variable data

``` r
response<-dat%>%
  dplyr::select(sample.no,count,size.class)%>%
  pivot_wider(names_from = size.class, values_from = count, values_fill = list(0))%>% #to make the data wide for PRIMER
  dplyr::glimpse()
```

    ## Observations: 2,134
    ## Variables: 4
    ## $ sample.no <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
    ## $ legal     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,…
    ## $ sub.legal <dbl> 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 17, 0, 2, 1, 0, 1, 0, 1, 1, 0…
    ## $ all       <dbl> 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 17, 0, 3, 1, 0, 1, 0, 1, 1, 0…

Make the covariate data

``` r
covariates<-dat%>%
  dplyr::select(sample.no,complexity,algal.cover,year)%>%
  dplyr::distinct()%>%
  dplyr::glimpse()
```

    ## Observations: 2,134
    ## Variables: 4
    ## $ sample.no   <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17…
    ## $ complexity  <dbl> 0, 2, 4, 1, 4, 2, 2, 2, 2, 1, 3, 1, 1, 2, 1, 3, 1, 2, 2, …
    ## $ algal.cover <dbl> 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, …
    ## $ year        <dbl> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 201…

Make the factor data

``` r
factors<-dat%>%
  dplyr::select(c(sample.no,sanctuary,status,site.new,year))%>%
 dplyr::distinct()%>% #only unique combinations - to match the wide data
  glimpse()
```

    ## Observations: 2,134
    ## Variables: 5
    ## $ sample.no <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
    ## $ sanctuary <chr> "Armstrong Bay", "Armstrong Bay", "Armstrong Bay", "Armstro…
    ## $ status    <chr> "No-take", "No-take", "No-take", "No-take", "No-take", "No-…
    ## $ site.new  <chr> "Little Armstrong.No-take", "Little Armstrong.No-take", "Li…
    ## $ year      <dbl> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014,…

Join the response.factor data

``` r
response.factors<-factors%>%
  dplyr::inner_join(response,by="sample.no")%>% #join the data
  dplyr::select(sample.no,legal,sub.legal,all,everything())%>% #orders the colums
  append_col(., list(blank=NA), after="all")%>% #appends blank colum
  plyr::rename(.,replace =c("blank"="") )%>% #makes the column name blank
  glimpse()
```

    ## Observations: 2,134
    ## Variables: 9
    ## $ sample.no <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
    ## $ legal     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,…
    ## $ sub.legal <dbl> 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 17, 0, 2, 1, 0, 1, 0, 1, 1, 0…
    ## $ all       <dbl> 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 17, 0, 3, 1, 0, 1, 0, 1, 1, 0…
    ## $ ``        <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
    ## $ sanctuary <chr> "Armstrong Bay", "Armstrong Bay", "Armstrong Bay", "Armstro…
    ## $ status    <chr> "No-take", "No-take", "No-take", "No-take", "No-take", "No-…
    ## $ site.new  <chr> "Little Armstrong.No-take", "Little Armstrong.No-take", "Li…
    ## $ year      <dbl> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014,…

Join the covariate.factor data

``` r
covariate.factors<-covariates%>%
  dplyr::inner_join(factors,by="sample.no")%>%
  append_col(., list(blank=NA), after="year.x")%>%
  plyr::rename(.,replace =c("blank"="") )%>%
  glimpse()
```

    ## Observations: 2,134
    ## Variables: 9
    ## $ sample.no   <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17…
    ## $ complexity  <dbl> 0, 2, 4, 1, 4, 2, 2, 2, 2, 1, 3, 1, 1, 2, 1, 3, 1, 2, 2, …
    ## $ algal.cover <dbl> 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 2, 2, …
    ## $ year.x      <dbl> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 201…
    ## $ ``          <lgl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ sanctuary   <chr> "Armstrong Bay", "Armstrong Bay", "Armstrong Bay", "Armst…
    ## $ status      <chr> "No-take", "No-take", "No-take", "No-take", "No-take", "N…
    ## $ site.new    <chr> "Little Armstrong.No-take", "Little Armstrong.No-take", "…
    ## $ year.y      <dbl> 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 2014, 201…

Write the data

``` r
setwd(primer.dir)
dir()
```

    ## [1] "covariate.factors.lobster.density.csv"
    ## [2] "response.factors.lobster.density.csv"

``` r
write.csv(response.factors,file=paste("response.factors",study,"csv",sep = "."), row.names=FALSE)

write.csv(covariate.factors,file=paste("covariate.factors",study,"csv",sep = "."), row.names=FALSE)

dir()
```

    ## [1] "covariate.factors.lobster.density.csv"
    ## [2] "response.factors.lobster.density.csv"

Go back to
[Analysis-lobster-density](https://github.com/UWA-BIOL4408-Marine-Ecology/Analysis-lobster-density/blob/master/README.md)
